{include file="app/admin/view/common/header_head.html" /}
<!-- start -->

<div class="layui-fluid">
    
    <div class="layui-card">
        <div class="layui-card-body">
            <div id="acl"></div>
        </div>
    </div>

    <div class="layui-btn-container">
        <!-- <button type="button" class="layui-btn layui-btn-sm" lay-demo="getChecked">获取选中节点数据</button> -->
        <!-- <button type="button" class="layui-btn layui-btn-sm" lay-demo="setChecked">勾选指定节点</button> -->
        <!-- <button type="button" class="layui-btn layui-btn-sm" lay-demo="reload">重载实例</button> -->
    </div>

    <div class="layui-form-item" style="text-align: center;">
        <input type="hidden" name="role_id" value="{$role_id|default='0'}">
        <button class="layui-btn layui-btn-sm" lay-acl="getChecked">保存</button>
        <button type="reset" class="layui-btn layui-btn-sm layui-btn-primary" lay-acl="reload">重置</button>
    </div>
</div>


<script type="text/javascript">

layui.config({base: '{__STATIC__}/admin/layuiadmin/'}).use(['tree','util','table','jquery'], function(){
///
var admin = layui.admin
,$ = layui.$
,form = layui.form
,table = layui.table;
var tree = layui.tree;
var util = layui.util;

tree.render({
    elem: '#acl',
    data: {$menu_data|raw},
    //是否显示复选框
    showCheckbox: true,
    id: 'acl_id'
    ,isJump: false
    ,click: function(obj){
        // console.log(obj);
    }
});

function getCheckedDataID(data){
    var ids = [];
    for (var i = 0; i < data.length; i++) {
        ids.push(data[i]['id']);

        if (data[i]['children']){
            var tmp_ids = getCheckedDataID(data[i]['children']);
            for (var j = 0; j < tmp_ids.length; j++) {
                ids.push(tmp_ids[j]);
            }
        }
    }
    return ids;
}

 //按钮事件
util.event('lay-acl', {
    getChecked: function(othis){
        var checkedData = tree.getChecked('acl_id');
        var role_id = $('input[name="role_id"]').val();
        if (role_id == 0){
            layer.msg("异常,不能设置!");
            return;
        }
        var ids = getCheckedDataID(checkedData);

        if (ids.length == 0){
            layer.confirm('你真的清空角色权限吗?', { closeBtn: 2, icon: 3 }, function() {
                $.post('{:url("adminrole/clearAcl")}', {'role_id':role_id}, function(data) {
                    showMsg(data.msg,function(){
                        if (data.code>-1){
                            location.reload();
                        }
                    },{icon:data.code>-1?1:2});
                },'json');
            });
        } else {
            $.post('{:url("adminrole/setAcl")}', {'role_id':role_id, 'ids':ids}, function(data) {
                showMsg(data.msg,function(){
                    if (data.code>-1){
                        location.reload();
                    }
                },{icon:data.code>-1?1:2});
            },'json');
        }        
    }
    ,reload: function(){
        //重载实例
        tree.reload('acl_id', {});
    }
});

///
});
</script>

<!-- end -->
</body>
</html>


